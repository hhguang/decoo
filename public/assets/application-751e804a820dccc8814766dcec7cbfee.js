!function(e,t){e.rails!==t&&e.error("jquery-ujs has already been loaded!");var a;e.rails=a={linkClickSelector:"a[data-confirm], a[data-method], a[data-remote], a[data-disable-with]",buttonClickSelector:"button[data-remote]",inputChangeSelector:"select[data-remote], input[data-remote], textarea[data-remote]",formSubmitSelector:"form",formInputClickSelector:"form input[type=submit], form input[type=image], form button[type=submit], form button:not([type])",disableSelector:"input[data-disable-with], button[data-disable-with], textarea[data-disable-with]",enableSelector:"input[data-disable-with]:disabled, button[data-disable-with]:disabled, textarea[data-disable-with]:disabled",requiredInputSelector:"input[name][required]:not([disabled]),textarea[name][required]:not([disabled])",fileInputSelector:"input[type=file]",linkDisableSelector:"a[data-disable-with]",CSRFProtection:function(t){var a=e('meta[name="csrf-token"]').attr("content");a&&t.setRequestHeader("X-CSRF-Token",a)},fire:function(t,a,i){var n=e.Event(a);return t.trigger(n,i),n.result!==!1},confirm:function(e){return confirm(e)},ajax:function(t){return e.ajax(t)},href:function(e){return e.attr("href")},handleRemote:function(i){var n,r,o,l,s,d,c,u;if(a.fire(i,"ajax:before")){if(l=i.data("cross-domain"),s=l===t?null:l,d=i.data("with-credentials")||null,c=i.data("type")||e.ajaxSettings&&e.ajaxSettings.dataType,i.is("form")){n=i.attr("method"),r=i.attr("action"),o=i.serializeArray();var f=i.data("ujs:submit-button");f&&(o.push(f),i.data("ujs:submit-button",null))}else i.is(a.inputChangeSelector)?(n=i.data("method"),r=i.data("url"),o=i.serialize(),i.data("params")&&(o=o+"&"+i.data("params"))):i.is(a.buttonClickSelector)?(n=i.data("method")||"get",r=i.data("url"),o=i.serialize(),i.data("params")&&(o=o+"&"+i.data("params"))):(n=i.data("method"),r=a.href(i),o=i.data("params")||null);u={type:n||"GET",data:o,dataType:c,beforeSend:function(e,n){return n.dataType===t&&e.setRequestHeader("accept","*/*;q=0.5, "+n.accepts.script),a.fire(i,"ajax:beforeSend",[e,n])},success:function(e,t,a){i.trigger("ajax:success",[e,t,a])},complete:function(e,t){i.trigger("ajax:complete",[e,t])},error:function(e,t,a){i.trigger("ajax:error",[e,t,a])},crossDomain:s},d&&(u.xhrFields={withCredentials:d}),r&&(u.url=r);var m=a.ajax(u);return i.trigger("ajax:send",m),m}return!1},handleMethod:function(i){var n=a.href(i),r=i.data("method"),o=i.attr("target"),l=e("meta[name=csrf-token]").attr("content"),s=e("meta[name=csrf-param]").attr("content"),d=e('<form method="post" action="'+n+'"></form>'),c='<input name="_method" value="'+r+'" type="hidden" />';s!==t&&l!==t&&(c+='<input name="'+s+'" value="'+l+'" type="hidden" />'),o&&d.attr("target",o),d.hide().append(c).appendTo("body"),d.submit()},disableFormElements:function(t){t.find(a.disableSelector).each(function(){var t=e(this),a=t.is("button")?"html":"val";t.data("ujs:enable-with",t[a]()),t[a](t.data("disable-with")),t.prop("disabled",!0)})},enableFormElements:function(t){t.find(a.enableSelector).each(function(){var t=e(this),a=t.is("button")?"html":"val";t.data("ujs:enable-with")&&t[a](t.data("ujs:enable-with")),t.prop("disabled",!1)})},allowAction:function(e){var t,i=e.data("confirm"),n=!1;return i?(a.fire(e,"confirm")&&(n=a.confirm(i),t=a.fire(e,"confirm:complete",[n])),n&&t):!0},blankInputs:function(t,a,i){var n,r,o=e(),l=a||"input,textarea",s=t.find(l);return s.each(function(){if(n=e(this),r=n.is("input[type=checkbox],input[type=radio]")?n.is(":checked"):n.val(),!r==!i){if(n.is("input[type=radio]")&&s.filter('input[type=radio]:checked[name="'+n.attr("name")+'"]').length)return!0;o=o.add(n)}}),o.length?o:!1},nonBlankInputs:function(e,t){return a.blankInputs(e,t,!0)},stopEverything:function(t){return e(t.target).trigger("ujs:everythingStopped"),t.stopImmediatePropagation(),!1},disableElement:function(e){e.data("ujs:enable-with",e.html()),e.html(e.data("disable-with")),e.bind("click.railsDisable",function(e){return a.stopEverything(e)})},enableElement:function(e){e.data("ujs:enable-with")!==t&&(e.html(e.data("ujs:enable-with")),e.removeData("ujs:enable-with")),e.unbind("click.railsDisable")}},a.fire(e(document),"rails:attachBindings")&&(e.ajaxPrefilter(function(e,t,i){e.crossDomain||a.CSRFProtection(i)}),e(document).delegate(a.linkDisableSelector,"ajax:complete",function(){a.enableElement(e(this))}),e(document).delegate(a.linkClickSelector,"click.rails",function(i){var n=e(this),r=n.data("method"),o=n.data("params");if(!a.allowAction(n))return a.stopEverything(i);if(n.is(a.linkDisableSelector)&&a.disableElement(n),n.data("remote")!==t){if(!(!i.metaKey&&!i.ctrlKey||r&&"GET"!==r||o))return!0;var l=a.handleRemote(n);return l===!1?a.enableElement(n):l.error(function(){a.enableElement(n)}),!1}return n.data("method")?(a.handleMethod(n),!1):void 0}),e(document).delegate(a.buttonClickSelector,"click.rails",function(t){var i=e(this);return a.allowAction(i)?(a.handleRemote(i),!1):a.stopEverything(t)}),e(document).delegate(a.inputChangeSelector,"change.rails",function(t){var i=e(this);return a.allowAction(i)?(a.handleRemote(i),!1):a.stopEverything(t)}),e(document).delegate(a.formSubmitSelector,"submit.rails",function(i){var n=e(this),r=n.data("remote")!==t,o=a.blankInputs(n,a.requiredInputSelector),l=a.nonBlankInputs(n,a.fileInputSelector);if(!a.allowAction(n))return a.stopEverything(i);if(o&&n.attr("novalidate")==t&&a.fire(n,"ajax:aborted:required",[o]))return a.stopEverything(i);if(r){if(l){setTimeout(function(){a.disableFormElements(n)},13);var s=a.fire(n,"ajax:aborted:file",[l]);return s||setTimeout(function(){a.enableFormElements(n)},13),s}return a.handleRemote(n),!1}setTimeout(function(){a.disableFormElements(n)},13)}),e(document).delegate(a.formInputClickSelector,"click.rails",function(t){var i=e(this);if(!a.allowAction(i))return a.stopEverything(t);var n=i.attr("name"),r=n?{name:n,value:i.val()}:null;i.closest("form").data("ujs:submit-button",r)}),e(document).delegate(a.formSubmitSelector,"ajax:beforeSend.rails",function(t){this==t.target&&a.disableFormElements(e(this))}),e(document).delegate(a.formSubmitSelector,"ajax:complete.rails",function(t){this==t.target&&a.enableFormElements(e(this))}),e(function(){var t=e("meta[name=csrf-token]").attr("content"),a=e("meta[name=csrf-param]").attr("content");e('form input[name="'+a+'"]').val(t)}))}(jQuery),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){window.Products={appendImageFromUpload:function(e){return $("#product-image").attr("src","/products/"+e),$("#image-url").attr("value",e),console.log(e)},initUploader:function(){var e;return $("#topic_add_image").bind("click",function(){return $("#topic_upload_images").click(),!1}),e={url:"/photos",type:"POST",beforeSend:function(){return $("#topic_add_image").hide(),$("#topic_add_image").before("<span class='loading'>上传中...</span>")},success:function(e){return $("#topic_add_image").parent().find("span").remove(),$("#topic_add_image").show(),Products.appendImageFromUpload([e])}},$("#topic_upload_images").fileUpload(e),!1}},$(document).ready(function(){return Products.initUploader()})}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(){}.call(this),function(e){var t=window.log||e.noop,a={fileError:function(e,t,a){window.alert(a)}},i=window.FileReader||window.File.prototype.getAsBinary,n=!!window.FormData,r=window.FileReader||window.File.prototype.getAsDataURL,o=!!document.createElement("canvas").toDataURL,l=o&&window.atob,s=!!document.createElement("canvas").mozGetAsFile,d=window.XMLHttpRequest&&window.XMLHttpRequest.prototype.sendAsBinary||window.ArrayBuffer&&window.BlobBuilder,c=!!window.FormData,u=!!document.createElement("canvas").toDataURL,f=i&&d||n&&c,m=r&&(l&&d||s&&c),p=r,h=r&&o,g=function(e){return e.substring(e.indexOf(",")+1,e.length)},b=function(e,a){var i={type:a.type||"",size:a.size||a.fileSize,name:a.name||a.fileName};if(e.resizeImage=!(!e.imageMaxWidth&&!e.imageMaxHeight),e.resizeImage&&!m&&e.allowUploadOriginalImage&&(t("WARN: Fall back to upload original un-resized image."),e.resizeImage=!1),e.resizeImage&&(e.imageMaxWidth=e.imageMaxWidth||1/0,e.imageMaxHeight=e.imageMaxHeight||1/0),!e.resizeImage){if(e.fileType&&e.fileType.test&&!e.fileType.test(i.name.substr(i.name.lastIndexOf(".")+1)))return t("ERROR: Invalid Filetype."),e.fileError.call(this,i,"INVALID_FILETYPE","Invalid filetype."),void 0;if(e.fileMaxSize&&a.size>e.fileMaxSize)return t("ERROR: File exceeds size limit."),e.fileError.call(this,i,"FILE_EXCEEDS_SIZE_LIMIT","File exceeds size limit."),void 0}if(!e.resizeImage&&n)t("INFO: Bypass file reading, insert file object into FormData object directly."),w(e,"file",a,i);else if(window.FileReader){t("INFO: Using FileReader to do asynchronously file reading.");var r=new FileReader;r.onerror=function(a){if(a.target.error)switch(a.target.error){case 8:t("ERROR: File not found."),e.fileError.call(this,i,"FILE_NOT_FOUND","File not found.");break;case 24:t("ERROR: File not readable."),e.fileError.call(this,i,"IO_ERROR","File not readable.");break;case 18:t("ERROR: File cannot be access due to security constrant."),e.fileError.call(this,i,"SECURITY_ERROR","File cannot be access due to security constrant.");break;case 20:}},e.resizeImage?(r.onloadend=function(t){var a=t.target.result;R(e,a,i)},r.readAsDataURL(a)):d?(r.onloadend=function(t){var a=t.target.result;w(e,"bin",a,i)},r.readAsBinaryString(a)):e.allowDataInBase64?(r.onloadend=function(t){w(e,"base64",g(t.target.result),i)},r.readAsDataURL(a)):(t("ERROR: No available method to extract file; allowDataInBase64 not set."),e.fileError.call(this,i,"NO_BIN_SUPPORT_AND_BASE64_NOT_SET","No available method to extract file; allowDataInBase64 not set."))}else if(window.File.prototype.getAsBinary)if(t("WARN: FileReader does not exist, UI will be blocked when reading big file."),e.resizeImage){try{var o=a.getAsDataURL()}catch(l){return t("ERROR: File not readable."),e.fileError.call(this,i,"IO_ERROR","File not readable."),void 0}R(e,dataurl,i)}else{try{var o=a.getAsBinary()}catch(l){return t("ERROR: File not readable."),e.fileError.call(this,i,"IO_ERROR","File not readable."),void 0}w(e,"bin",o,i)}else t("ERROR: No available method to extract file; this browser is not supported."),e.fileError.call(this,i,"NOT_SUPPORT","ERROR: No available method to extract file; this browser is not supported.")},R=function(e,a,i){var n=new Image;n.onerror=function(){t("ERROR: <img> failed to load, file is not a supported image format."),e.fileError.call(this,i,"FILE_NOT_IMAGE","File is not a supported image format.")},n.onload=function(){var r=Math.max(n.width/e.imageMaxWidth,n.height/e.imageMaxHeight,1),f={w:Math.floor(Math.max(n.width/r,1)),h:Math.floor(Math.max(n.height/r,1))};if(t("INFO: Original image size: "+n.width.toString(10)+"x"+n.height.toString(10)+", resized image size: "+f.w+"x"+f.h+"."),!e.forceResize&&n.width===f.w&&n.height===f.h)return t("INFO: Image demension is the same, send the original file."),l?w(e,"bin",window.atob(g(a)),i):e.allowDataInBase64?w(e,"base64",g(a),i):(t("ERROR: No available method to send the original file; allowDataInBase64 not set."),e.fileError.call(this,i,"NO_BIN_SUPPORT_AND_BASE64_NOT_SET","No available method to extract file; allowDataInBase64 not set.")),void 0;var m=document.createElement("canvas");m.setAttribute("width",f.w),m.setAttribute("height",f.h),m.getContext("2d").drawImage(n,0,0,n.width,n.height,0,0,f.w,f.h),e.imageType&&"auto"!==e.imageType||(e.imageType="image/jpeg"===i.type?"jpeg":"png");var p={type:"image/"+e.imageType,name:i.name.substr(0,i.name.indexOf("."))+".resized."+e.imageType};if(s&&c){var h=m.mozGetAsFile(p.name,"image/"+e.imageType);p.size=file.size||file.fileSize,w(e,"file",h,p)}else if(l&&d){var b=window.atob(g(m.toDataURL("image/"+e.imageType)));p.size=b.length,w(e,"bin",b,p)}else e.allowDataInBase64&&o&&u?w(e,"base64",g(m.toDataURL("image/"+e.imageType)),p):(t("ERROR: No available method to extract image; allowDataInBase64 not set."),e.fileError.call(this,i,"NO_BIN_SUPPORT_AND_BASE64_NOT_SET","No available method to extract file; allowDataInBase64 not set."))},n.src=a},w=function(a,i,n,r){if(c&&"file"===i){t("INFO: Using FormData to construct form.");var o=new FormData;o.append("Filedata",n),a.processData=!1,a.contentType=null,a.__beforeSend=a.beforeSend,a.beforeSend=function(e,t){return t.data=o,t.__beforeSend?t.__beforeSend.call(this,e,t):void 0}}else if(d&&"bin"===i){t("INFO: Concat our own multipart/form-data data string."),r.type||(r.type="application/octet-stream"),/[^\x20-\x7E]/.test(r.name)&&(t("INFO: Filename contains non-ASCII code, do UTF8-binary string conversion."),r.name_bin=unescape(encodeURIComponent(r.name)));var l="xhrupload-"+parseInt(Math.random()*(2<<16));a.contentType="multipart/form-data; boundary="+l;var o="--"+l+"\n"+'content-disposition: form-data; name="Filedata";'+' filename="'+(r.name_bin||r.name)+'"\n'+"Content-Type: "+r.type+"\n\n"+n+"\n\n"+"--"+l+"--";if(window.XMLHttpRequest.prototype.sendAsBinary)t("INFO: Pass binary string to xhr."),a.data=o;else{t("INFO: Convert binary string into Blob.");var s=new ArrayBuffer(o.length),u=new Uint8Array(s);e.each(o,function(e,t){u[e]=t.charCodeAt(0)});var f=new BlobBuilder;f.append(s);var m=f.getBlob();a.processData=!1,a.__beforeSend=a.beforeSend,a.beforeSend=function(e,t){return t.data=m,t.__beforeSend?t.__beforeSend.call(this,e,t):void 0}}}else{if(!a.allowDataInBase64||"base64"!==i)return t("ERROR: Data is not given in processable form."),a.fileError.call(this,r,"INTERNAL_ERROR","Data is not given in processable form."),void 0;t("INFO: Concat our own multipart/form-data data string; send the file in base64 because binary xhr is not supported."),r.type||(r.type="application/octet-stream");var l="xhrupload-"+parseInt(Math.random()*(2<<16));a.contentType="multipart/form-data; boundary="+l,a.data="--"+l+"\n"+'content-disposition: form-data; name="Filedata";'+' filename="'+encodeURIComponent(r.name)+'.base64"\n'+"Content-Transfer-Encoding: base64\n"+"Content-Type: "+r.type+"\n\n"+n+"\n\n"+"--"+l+"--"}y(a)},y=function(a){t("INFO: Sending file."),"string"==typeof a.data&&d&&(t("INFO: Using xhr.sendAsBinary."),a.___beforeSend=a.beforeSend,a.beforeSend=function(e,t){return e.send=e.sendAsBinary,t.___beforeSend?t.___beforeSend.call(this,e,t):void 0}),e.ajax(a)};e.fn.fileUpload=function(i){return this.each(function(n,r){e(r).is("input[type=file]")&&(t("INFO: binding onchange event to a input[type=file]."),e(r).bind("change",function(){return this.files.length?(this.files.length>1&&t("WARN: Multiple file upload not implemented yet, only first file will be uploaded."),b(e.extend({},a,i),this.files[0]),1===this.form.length?this.form.reset():t("WARN: Unable to reset file selection, upload won't be triggered again if user selects the same file."),void 0):(t("ERROR: no file selected."),void 0)})),e(r).is("form")?t("ERROR: <form> not implemented yet."):(t("INFO: binding ondrop event."),e(r).bind("dragover",function(){return!1}).bind("drop",function(n){return n.originalEvent.dataTransfer.files?n.originalEvent.dataTransfer.files.length?(!n.originalEvent.dataTransfer.files.length>1&&t("WARN: Multiple file upload not implemented yet, only first file will be uploaded."),b(e.extend({},a,i),n.originalEvent.dataTransfer.files[0]),!1):(t('ERROR: User had dropped a virual file (e.g. "My Computer")'),!1):(t("ERROR: No FileList object present; user might had dropped text."),!1)}))}),this},e.fileUploadSupported=f,e.imageUploadSupported=m,e.fileUploadAsBase64Supported=p,e.imageUploadAsBase64Supported=h}(jQuery);